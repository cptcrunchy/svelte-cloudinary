<!--
	@component
	
	This component can embed a Cloudinary video the Cloudinary Video Player.

	@see https://svelte.cloudinary.dev/components/video-player

	@example Simple Video Example

	```svelte
	<script>
		import { CldVideoPlayer } from 'svelte-cloudinary';
	</script>

	<CldVideoPlayer width="1920" height="1080" src="videos/mountain-stars" />
	```
-->

<script lang="ts" module>
	import type { CloudinaryVideoPlayer } from '@cloudinary-util/types';
	import type {
		ConfigOptions,
		GetVideoPlayerOptions,
	} from '@cloudinary-util/url-loader';

	type CldVideoPlayerEvent = (options: {
		player: CloudinaryVideoPlayer;
		video: HTMLVideoElement;
	}) => unknown;

	export type CldVideoPlayerProps = GetVideoPlayerOptions & {
		/**
		 * Overrides for the global Cloudinary config.
		 * @see https://svelte.cloudinary.dev/config
		 */
		config?: ConfigOptions;

		/**
		 * Custom id to use
		 */
		id?: string;

		/**
		 * You can bind to this prop if you need to access the Cloudinary
		 * Video Player directly.
		 * @readonly
		 */
		player?: CloudinaryVideoPlayer | undefined;

		/**
		 * You can bind to this prop if you need to access the <video />
		 * element directly.
		 * @readonly
		 */
		videoElement?: HTMLVideoElement | undefined;

		/**
		 * Fires when an error in video playback occurs
		 */
		onError?: CldVideoPlayerEvent;

		/**
		 * Fires when video data is loaded
		 */
		onDataLoad?: CldVideoPlayerEvent;

		/**
		 * Fires when video metadata is loaded
		 */
		onMetadataLoad?: CldVideoPlayerEvent;

		/**
		 * Fires when the video is paused
		 */
		onPause?: CldVideoPlayerEvent;

		/**
		 * Fires when the video is played
		 */
		onPlay?: CldVideoPlayerEvent;

		/**
		 * Fires when the video ends
		 */
		onEnded?: CldVideoPlayerEvent;
	};
</script>

<script lang="ts">
	import { getVideoPlayerOptions } from '@cloudinary-util/url-loader';
	import { loadScript } from '../internal/scripts';
	import { mergeGlobalConfig } from '../config';
	import { onDestroy, onMount } from 'svelte';

	const PLAYER_VERSION = '1.11.1';

	interface Props extends CldVideoPlayerProps {}

	let {
		config,
		id,
		player = $bindable(),
		videoElement = $bindable(),
		onError,
		onDataLoad,
		onMetadataLoad,
		onPause,
		onPlay,
		onEnded,
		...videoPlayerOptions
	}: Props = $props();

	// Reactive options calculation
	let options = $derived(
		getVideoPlayerOptions(
			videoPlayerOptions,
			mergeGlobalConfig(config).config,
		),
	);

	// Track loading state
	let loaded = $state(
		typeof window != 'undefined' && !!window.cloudinary?.videoPlayer,
	);

	// Effect to initialize player when dependencies are ready
	$effect(() => {
		if (videoElement && loaded && !player) {
			player = window.cloudinary?.videoPlayer?.(videoElement, options);

			// Set up event listeners
			player?.on('error', () =>
				onError?.({
					player: player!,
					video: videoElement!,
				}),
			);

			player?.on('loadeddata', () =>
				onDataLoad?.({
					player: player!,
					video: videoElement!,
				}),
			);

			player?.on('loadedmetadata', () =>
				onMetadataLoad?.({
					player: player!,
					video: videoElement!,
				}),
			);

			player?.on('pause', () =>
				onPause?.({
					player: player!,
					video: videoElement!,
				}),
			);

			player?.on('play', () =>
				onPlay?.({
					player: player!,
					video: videoElement!,
				}),
			);

			player?.on('ended', () =>
				onEnded?.({
					player: player!,
					video: videoElement!,
				}),
			);
		}
	});

	onMount(() => {
		loadScript({
			src: `https://unpkg.com/cloudinary-video-player@${PLAYER_VERSION}/dist/cld-video-player.min.js`,
			onLoad() {
				loaded = true;
			},
			onError() {
				console.error('Failed to load the Cloudinary Video Player SDK');
			},
		});
	});

	onDestroy(() => {
		player?.dispose();
	});
</script>

<svelte:head>
	<link
		href="https://unpkg.com/cloudinary-video-player@{PLAYER_VERSION}/dist/cld-video-player.min.css"
		rel="stylesheet" />
</svelte:head>

<div
	style="width: 100%;"
	style:aspect-ratio="{options.width} / {options.height}">
	<video
		id={id || options.publicId}
		width={options.width}
		height={options.height}
		bind:this={videoElement}
		class="cld-video-player cld-fluid">
		<track kind="captions" />
	</video>
</div>
